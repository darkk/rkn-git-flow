#!/bin/bash -e

instance=$(hostname)
evil_pkt=$(iptables -L INPUT -vn | awk '/ evil / {print $1}')

if [ -n "$evil_pkt" ]; then
  curl -X PUT --data-binary @- \
  --cert <(cat <<EOF
-----BEGIN CERTIFICATE-----
MIIC/zCCAecCEQCqKdexH3zTjFSs5ZGoAkQYMA0GCSqGSIb3DQEBCwUAMDsxDTAL
BgNVBAoMBE9PTkkxCzAJBgNVBAsMAkNBMR0wGwYDVQQDDBRQcm9tZXRoZXVzIFB1
c2hlciBDQTAeFw0xODA5MjAxMDM5MDJaFw0yODA5MTcxMDM5MDJaMEAxDTALBgNV
BAoMBE9PTkkxGjAYBgNVBAsMEVByb21ldGhldXMgUHVzaGVyMRMwEQYDVQQDDApk
YXJrayBzNXRnMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAtPQLALAE
fEa8Z7BV4QEBCPyswm3Rskl8fJB6ujWVnLMvmcUpfS5oF6aKHe21YpoVU2cDwfv7
VqFE6IZ1GMwcRy0Bj5VSInnxMnyD9igleKP+aJgaCehtevVVtol6rEcHKuAKCk8w
r7yW3TJ1oyo9VFMKrevF4LDvRwgmxTgYWwzwUkAqYatIp6vLP/UOCfJxK6jqCwUS
5hz1/UCiTpMGKNTBLc3GnIFWSRI+TypHFq8LJzk9JNQSPWj2mfSp44u9B0sJN6ee
rQ2HnUXlOxx85kyMLWfa+E54hopSretVm2x3iiwLqxH/PMe2tBTBTHpRCSyhvQ3V
uAadB24MKMukBQIDAQABMA0GCSqGSIb3DQEBCwUAA4IBAQAI6aX/NIZrUkW6ToDG
hDyPsrxlcaD00+I7hemzgnsP4jVPngEg+ysx20vWULBq4pFVvEFN/wT62SNnGPYU
HhmxVyd/DC4Qha4bU7gkyR2aH3pJ+3TmLrSrLbt5miwGrHGUpkQis5wzE+FLD6cz
cDmhi3es9M3R2CXuR5NbdZ7gA4KYtghBH3gpUQVSuc+Mz2atei2O+WLl60G8+Hbq
TTd7Rvd5yHPiqeqRHbEp53/B78azJzqO+Uqutt1D/rkod+9cJ/3YVqEJdH+eqRmj
C4ZUO7pDl3PC36nEtaagf3wu8+VyMmEgXY0A92T/W3B53jSAGHM64LN94HIleDoh
8+In
-----END CERTIFICATE-----
EOF
) \
  --key <(cat <<EOF
-----BEGIN RSA PRIVATE KEY-----
MIIEpAIBAAKCAQEAtPQLALAEfEa8Z7BV4QEBCPyswm3Rskl8fJB6ujWVnLMvmcUp
fS5oF6aKHe21YpoVU2cDwfv7VqFE6IZ1GMwcRy0Bj5VSInnxMnyD9igleKP+aJga
CehtevVVtol6rEcHKuAKCk8wr7yW3TJ1oyo9VFMKrevF4LDvRwgmxTgYWwzwUkAq
YatIp6vLP/UOCfJxK6jqCwUS5hz1/UCiTpMGKNTBLc3GnIFWSRI+TypHFq8LJzk9
JNQSPWj2mfSp44u9B0sJN6eerQ2HnUXlOxx85kyMLWfa+E54hopSretVm2x3iiwL
qxH/PMe2tBTBTHpRCSyhvQ3VuAadB24MKMukBQIDAQABAoIBAGu33xjgrzrfzOYY
tXbE5z3XVGxFfZAZaM6qHzTcExz+Gfb6xHDtgC+cBxo72D9DJDDK4RTIEN2IEQIu
kGRblPXV19kGdadqWefI8bFGQtAnJ5pR+SYuw4VvqD+KZYlKmvyt86whagUjSdeR
Yy/nRCz/ZhsUgG36ReZN9u5uLyl7cN/AQJziL12tRpwCNh9AzyC3yS3pi1n2oEqf
YM4aGGCXebTeL2TlUqfZyA4R3WHCWZGKxGI/33mfWZQJXFo5gl6+n7slFuJ0xl0C
Gfes9geRuhM9tyZm6olb8sAJShtnz62g4kSPUJ3kxDT1RybSFR1CJxLJT38eXQxf
TBq2YF0CgYEA364W/8/qfUCAaYzYQw7MqS9u3remo5aCELQjWcGxxB70lmEfdgXM
CUEtOmBd4s8uVZ0XNFpU+PLFFvAi29BqGXHw0iSylyxBRQVBK/y7w7fa/A+vTQax
+zuoBe9NY8GCeCyp/gkzzG0sUISi7lrfyPFKbMwFYLkNhXzwokwtyPcCgYEAzxl+
W3Ro1/NGd6QN1mHyboRDKn18LaEhZL/J7l+SDx7DYMuXpEQF+4s4zhmObl++htvc
AY2X+hEUhVD9xhkhQScr28/8x1tYPyTIF3e5DiRBKiM4nuzd2LRqhJLPMpEcMhRV
GSbwlXRyRmUIWNh2ob3YiEjqDBgqRb0UepMt1+MCgYEAiYEb4maOYDEmv7w1tgOD
DP57ya5cYnRDwMD8elD4Vvgwo8FQ9dzacVX/18Ml9Cgo87h+a1Ccq+2R+2fkBf05
PCsvQAAPSZ+LAEMarU/QnaCIniuGOHPFNgyWXg+eI5Tx/651UhWWIjV66IShJKX4
rC6o8fj51VvtVAJaa2spOkECgYEAwp7ek+ttq6M/EafmKRWa0ikRRZjvXaIS0684
gP7nL7ZlPU2WkBQs2xsWovh5VVg8oFd1BTCfJa1vb2mRUtzC14uMN+HZVy+MWqqi
LwufqJ6BbqvyxccrJD9H6pZciNS9foKFBkIFzS3FRkoj8fpaYd0a49hBumPrNeZe
nGI7rqkCgYAqblWLza/BhGijUDfs8lH0OTjbOZpmMrNLLBdjmTms27o6wpHUPqEL
V8z8cGFyDbYhKrqE/SGOp+r94vXgBjLyH9IzOilK0uKNKJEGDzjgYesuZrG5YkAK
/xzYDyKhEimYjI/vUvgDy/C6VAO0D8w0HEnFrXAx0GLwLBAF/SOnvA==
-----END RSA PRIVATE KEY-----
EOF
) \
  "https://prometheus.infra.ooni.io:9091/metrics/job/evil/instance/${instance}" \
  <<EOF
# HELP s5tg_evil_pkt Number of packets from evil host.
# TYPE s5tg_evil_pkt counter
s5tg_evil_pkt ${evil_pkt}
EOF
fi
